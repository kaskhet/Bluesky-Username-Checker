import requests
from concurrent.futures import ThreadPoolExecutor, as_completed
import sys

API = "https://bsky.social/xrpc/com.atproto.identity.resolveHandle?handle={handle}"

INPUT_FILE = "handles.txt"
VALID_FILE = "valid_handles.txt"
INVALID_FILE = "invalid_handles.txt"

def check_handle(handle: str) -> tuple[str, bool]:
    handle = handle.strip()
    if not handle:
        return handle, False
    try:
        url = API.format(handle=handle)
        res = requests.get(url, timeout=6)
        # If we get a 404 or failure, we *assume* handle might be available
        # 200 means it's taken/exists
        if res.status_code == 404:
            return handle, True
        return handle, False
    except Exception as e:
        print(f"Error checking {handle}: {e}")
        return handle, False

def main():
    try:
        with open(INPUT_FILE, "r") as f:
            handles = [line.strip() for line in f if line.strip()]
    except FileNotFoundError:
        print(f"ERROR: {INPUT_FILE} not found")
        sys.exit(1)

    valid = []
    invalid = []

    with ThreadPoolExecutor(max_workers=20) as pool:
        futures = { pool.submit(check_handle, h): h for h in handles }
        for future in as_completed(futures):
            h, is_available = future.result()
            if is_available:
                print(f"[AVAILABLE] {h}")
                valid.append(h)
            else:
                print(f"[TAKEN] {h}")
                invalid.append(h)

    with open(VALID_FILE, "w") as f:
        f.write("\n".join(valid))
    with open(INVALID_FILE, "w") as f:
        f.write("\n".join(invalid))
    print(f"\nDone! {len(valid)} handles available.")

if __name__ == "__main__":
    main()